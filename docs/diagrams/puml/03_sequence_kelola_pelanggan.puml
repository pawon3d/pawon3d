@startuml Sequence Diagram - Mengelola Pelanggan

actor Pemilik
participant "Customer Page\n(Livewire)" as Page
participant "Customer\nModel" as Customer
participant "PointsHistory\nModel" as Points
participant "Transaction\nModel" as Transaction
database Database as DB

== Menambah Pelanggan ==
Pemilik -> Page: Klik "Tambah Pelanggan"
Page --> Pemilik: Tampilkan form

Pemilik -> Page: Isi data pelanggan
note right
  - Nama
  - Nomor telepon
end note

Pemilik -> Page: Simpan

Page -> Customer: where('phone', phone)->exists()
Customer -> DB: SELECT * FROM customers WHERE phone = ?
DB --> Customer: exists check

alt Nomor telepon sudah ada
    Page --> Pemilik: Error: Nomor telepon sudah terdaftar
else Nomor baru
    Page -> Customer: create(data)
    Customer -> DB: INSERT INTO customers (points = 0)
    DB --> Customer: customer created
    Page --> Pemilik: Pelanggan berhasil ditambahkan
end

== Melihat Detail Pelanggan ==
Pemilik -> Page: Pilih pelanggan
Page -> Customer: find(id)
Customer -> DB: SELECT * FROM customers
DB --> Customer: customer data

Page -> Points: where('phone', customer.phone)->latest()
Points -> DB: SELECT * FROM points_histories
DB --> Points: points history

Page -> Transaction: where('customer_id', id)->latest()
Transaction -> DB: SELECT * FROM transactions
DB --> Transaction: transactions list

Page --> Pemilik: Tampilkan detail pelanggan
note right
  - Info pelanggan
  - Total poin
  - Riwayat poin
  - Riwayat transaksi
end note

== Menambah/Mengurangi Poin Manual ==
Pemilik -> Page: Pilih "Atur Poin"
Pemilik -> Page: Pilih aksi (tambah/kurang)
Pemilik -> Page: Masukkan jumlah poin
Pemilik -> Page: Masukkan alasan

alt Tambah Poin
    Page -> Customer: increment('points', amount)
    Customer -> DB: UPDATE customers SET points = points + amount
    DB --> Customer: updated
    
    Page -> Points: create(addHistory)
    note right
      action: 'manual_add'
      points: +amount
      description: alasan
    end note
    Points -> DB: INSERT INTO points_histories
    
else Kurangi Poin
    Page -> Customer: find(id)
    Customer --> Page: current points
    
    alt Poin cukup
        Page -> Customer: decrement('points', amount)
        Customer -> DB: UPDATE customers SET points = points - amount
        DB --> Customer: updated
        
        Page -> Points: create(deductHistory)
        note right
          action: 'manual_deduct'
          points: -amount
          description: alasan
        end note
        Points -> DB: INSERT INTO points_histories
    else Poin tidak cukup
        Page --> Pemilik: Error: Poin tidak mencukupi
    end
end

Page --> Pemilik: Poin berhasil diupdate

== Mengedit Pelanggan ==
Pemilik -> Page: Pilih edit
Page -> Customer: find(id)
Customer --> Page: customer data
Page --> Pemilik: Tampilkan form edit

Pemilik -> Page: Ubah data
Pemilik -> Page: Simpan

Page -> Customer: update(data)
Customer -> DB: UPDATE customers
DB --> Customer: updated

Page --> Pemilik: Pelanggan berhasil diupdate

== Menghapus Pelanggan ==
Pemilik -> Page: Pilih hapus
Page --> Pemilik: Konfirmasi hapus?
Pemilik -> Page: Konfirmasi

Page -> Transaction: where('customer_id', id)->exists()
Transaction -> DB: SELECT COUNT(*) FROM transactions

alt Pelanggan punya transaksi
    Page --> Pemilik: Error: Pelanggan tidak bisa dihapus
else Tidak ada transaksi
    Page -> Customer: delete(id)
    Customer -> DB: DELETE FROM customers
    Page --> Pemilik: Pelanggan berhasil dihapus
end

@enduml
