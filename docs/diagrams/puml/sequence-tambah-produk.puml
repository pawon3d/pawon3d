@startuml sequence-tambah-produk

title Sequence Diagram: Tambah Produk dengan Komposisi

actor "Bagian Inventori" as user
participant "Product/Form\n(Livewire)" as form
participant "Product\n(Model)" as product
participant "ProductComposition\n(Model)" as comp
participant "OtherCost\n(Model)" as cost
database "Database" as db

user -> form : Akses halaman tambah produk
activate form

form -> form : Render form

user -> form : Isi data produk\n(nama, kategori, harga, metode)
user -> form : Upload gambar (opsional)

user -> form : Tambah komposisi bahan
note right
    User menambahkan:
    - Bahan baku (material)
    - Satuan (unit)
    - Kuantitas per porsi
end note

user -> form : Tambah biaya tambahan (opsional)
note right
    User menambahkan:
    - Jenis biaya
    - Jumlah biaya
end note

form -> form : Validasi input

alt Validasi gagal
    form --> user : Tampilkan pesan error
else Validasi berhasil
    
    form -> product : create(productData)
    activate product
    product -> product : boot()\nGenerate UUID
    product -> db : INSERT INTO products
    db --> product : OK
    product --> form : Product created (product_id)
    deactivate product
    
    loop Untuk setiap komposisi bahan
        form -> comp : create(product_id, material_id, unit_id, qty)
        activate comp
        comp -> comp : Generate UUID
        comp -> db : INSERT INTO product_compositions
        db --> comp : OK
        deactivate comp
    end
    
    opt Ada biaya tambahan
        loop Untuk setiap biaya
            form -> cost : create(product_id, type_cost_id, amount)
            activate cost
            cost -> cost : Generate UUID
            cost -> db : INSERT INTO other_costs
            db --> cost : OK
            deactivate cost
        end
    end
    
    form -> form : Hitung harga modal
    note right
        Harga modal = 
        SUM(komposisi * harga bahan) +
        SUM(biaya tambahan)
    end note
    
    form --> user : Tampilkan notifikasi sukses
    form -> form : Redirect ke daftar produk
end

deactivate form

@enduml
