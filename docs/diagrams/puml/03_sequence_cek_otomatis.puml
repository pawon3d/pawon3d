@startuml Sequence Diagram - Pengecekan Otomatis

participant "Laravel Scheduler" as Scheduler
participant "CheckInventoryAlerts\nCommand" as Command
participant "Material\nModel" as Material
participant "MaterialBatch\nModel" as Batch
participant "User\nModel" as User
participant "NotificationService" as Notif
database Database as DB

== Trigger Harian (08:00) ==
Scheduler -> Command: handle()
note right
  Dijalankan via cron:
  * 8 * * * php artisan schedule:run
end note

== Cek Stok Rendah ==
Command -> Material: where('is_active', true)->get()
Material -> DB: SELECT * FROM materials WHERE is_active = 1
DB --> Material: active materials

loop Untuk setiap material
    Command -> Batch: where('material_id', id)\n->where('quantity', '>', 0)->sum('quantity')
    Batch -> DB: SUM(quantity) FROM material_batches
    DB --> Batch: total_stock
    
    alt total_stock = 0
        Command -> Material: update(['status' => 'Kosong'])
        Material -> DB: UPDATE materials SET status = 'Kosong'
        Command -> Command: Tambah ke daftar alert
        
    else total_stock <= minimum
        Command -> Material: update(['status' => 'Hampir Habis'])
        Material -> DB: UPDATE materials SET status = 'Hampir Habis'
        Command -> Command: Tambah ke daftar alert
        
    else total_stock > minimum
        Command -> Material: update(['status' => 'Tersedia'])
        Material -> DB: UPDATE materials SET status = 'Tersedia'
    end
end

alt Ada material dengan stok rendah
    Command -> Notif: lowStockAlert(materials_list)
    Notif -> User: getWithPermission('inventori.*')
    User -> DB: SELECT users with inventori permissions
    DB --> User: users list
    
    loop Untuk setiap user inventori
        Notif -> DB: INSERT INTO notifications
        note right
          title: Alert Stok
          body: Daftar bahan hampir habis
          type: inventori
        end note
    end
end

== Cek Expired ==
Command -> Batch: where('expired_at', '<=', today())\n->where('quantity', '>', 0)->get()
Batch -> DB: SELECT FROM material_batches
DB --> Batch: expired batches

loop Untuk setiap batch expired
    Command -> Material: find(batch.material_id)
    Command -> Material: update(['status' => 'Expired'])
    Material -> DB: UPDATE materials SET status = 'Expired'
    Command -> Command: Tambah ke daftar alert expired
end

Command -> Batch: where('expired_at', '<=', today + 7 days)\n->where('expired_at', '>', today())
Batch -> DB: SELECT (akan expired dalam 7 hari)
DB --> Batch: expiring soon batches

loop Untuk setiap batch akan expired
    Command -> Command: Tambah ke daftar alert akan expired
end

alt Ada material expired/akan expired
    Command -> Notif: expiringAlert(materials_list)
    Notif -> User: getWithPermission('inventori.*')
    
    loop Untuk setiap user inventori
        Notif -> DB: INSERT INTO notifications
        note right
          title: Alert Expired
          body: Daftar bahan expired/akan expired
          type: inventori
        end note
    end
end

Command --> Scheduler: Command completed

@enduml
