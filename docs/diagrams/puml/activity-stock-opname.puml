@startuml activity-stock-opname

title Activity Diagram: Stock Opname (Hitung)

start

:Pengguna mengakses halaman hitung;

partition "Perencanaan Stock Opname" {
    :Buat rencana hitung baru;
    :Generate nomor hitung (HC-YYMMDD-XXXX);
    :Pilih tanggal hitung;
    
    repeat
        :Pilih bahan baku yang akan dihitung;
        :Sistem menampilkan kuantitas sistem;
    repeat while (Tambah item lagi?) is (Ya)
    -> Tidak;
    
    :Simpan rencana hitung;
    :Status = Rencana;
    :Catat log aktivitas;
}

partition "Pelaksanaan Stock Opname" {
    :Pilih rencana hitung;
    :Mulai proses penghitungan;
    :Status = Dalam Proses;
    
    repeat
        :Pilih item bahan;
        :Sistem menampilkan kuantitas sistem;
        :Masukkan kuantitas aktual hasil hitung;
        :Sistem menghitung selisih otomatis;
        
        if (Ada selisih?) then (Ya)
            :Tandai item perlu penyesuaian;
            :Masukkan catatan (opsional);
        else (Tidak)
            :Item sesuai;
        endif
        
    repeat while (Item berikutnya?) is (Ya)
    -> Tidak;
    
    if (Konfirmasi selesai?) then (Ya)
        fork
            :Simpan hasil hitung;
        fork again
            repeat
                if (Ada selisih?) then (Ya)
                    :Update batch_quantity pada MaterialBatch;
                    :Catat inventory_log dengan action = penyesuaian;
                else (Tidak)
                endif
            repeat while (Item berikutnya?) is (Ya)
            -> Tidak;
        fork again
            :Update status bahan (recalculateStatus);
        end fork
        
        :Status = Selesai;
        :Catat log aktivitas;
        :Tampilkan ringkasan hasil hitung;
        :Tampilkan notifikasi sukses;
    else (Tidak)
        :Simpan sebagai draft;
    endif
}

partition "Riwayat Stock Opname" {
    if (Lihat riwayat?) then (Ya)
        :Tampilkan daftar stock opname selesai;
        :Pilih untuk melihat detail;
        :Tampilkan hasil hitung per item;
    else (Tidak)
    endif
}

stop

@enduml
