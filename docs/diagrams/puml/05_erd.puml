@startuml ERD - Sistem Manajemen Toko Kue

!define primary_key(x) <b><u>x</u></b>
!define foreign_key(x) <i>x</i>
!define not_null(x) <b>x</b>

skinparam linetype ortho
skinparam class {
    BackgroundColor White
    BorderColor Black
}

' === USER & AUTH ===
entity "users" as users {
    primary_key(id) : uuid
    --
    not_null(name) : varchar(255)
    not_null(email) : varchar(255) <<unique>>
    phone : varchar(20)
    not_null(password) : varchar(255)
    image : varchar(255)
    gender : varchar(20)
    not_null(is_active) : boolean <<default:false>>
    invitation_token : varchar(64) <<unique>>
    invitation_expires_at : timestamp
    activated_at : timestamp
    remember_token : varchar(100)
    created_at : timestamp
    updated_at : timestamp
}

entity "roles" as roles {
    primary_key(id) : bigint
    --
    not_null(name) : varchar(255)
    not_null(guard_name) : varchar(255)
    created_at : timestamp
    updated_at : timestamp
}

entity "permissions" as permissions {
    primary_key(id) : bigint
    --
    not_null(name) : varchar(255)
    not_null(guard_name) : varchar(255)
    created_at : timestamp
    updated_at : timestamp
}

entity "model_has_roles" as model_has_roles {
    primary_key(role_id) : bigint <<FK>>
    primary_key(model_type) : varchar(255)
    primary_key(model_id) : uuid
}

entity "role_has_permissions" as role_has_permissions {
    primary_key(permission_id) : bigint <<FK>>
    primary_key(role_id) : bigint <<FK>>
}

entity "notifications" as notifications {
    primary_key(id) : uuid
    --
    foreign_key(user_id) : uuid <<FK>>
    title : varchar(255)
    not_null(body) : text
    type : varchar(50)
    not_null(is_read) : boolean
    created_at : timestamp
    updated_at : timestamp
}

' === CUSTOMER & POINTS ===
entity "customers" as customers {
    primary_key(id) : uuid
    --
    not_null(phone) : varchar(20) <<unique>>
    name : varchar(255)
    not_null(points) : integer
    created_at : timestamp
    updated_at : timestamp
}

entity "points_histories" as points_histories {
    primary_key(id) : uuid
    --
    not_null(phone) : varchar(20) <<FK>>
    foreign_key(transaction_id) : uuid <<FK>>
    not_null(action) : varchar(50)
    not_null(points) : integer
    description : text
    created_at : timestamp
    updated_at : timestamp
}

' === PRODUCT ===
entity "products" as products {
    primary_key(id) : uuid
    --
    not_null(name) : varchar(255)
    description : text
    not_null(price) : decimal(15,2)
    not_null(stock) : integer
    method : json
    is_recipe : boolean
    is_ready : boolean
    pcs : integer
    capital : decimal(15,2)
    foreign_key(category_id) : uuid <<FK>>
    product_image : varchar(255)
    suhu_ruangan : integer
    suhu_dingin : integer
    suhu_beku : integer
    created_at : timestamp
    updated_at : timestamp
}

entity "categories" as categories {
    primary_key(id) : uuid
    --
    not_null(name) : varchar(255)
    description : text
    created_at : timestamp
    updated_at : timestamp
}

entity "product_categories" as product_categories {
    primary_key(id) : uuid
    --
    foreign_key(product_id) : uuid <<FK>>
    foreign_key(category_id) : uuid <<FK>>
}

entity "product_compositions" as product_compositions {
    primary_key(id) : uuid
    --
    foreign_key(product_id) : uuid <<FK>>
    foreign_key(material_id) : uuid <<FK>>
    not_null(quantity) : decimal(15,4)
    unit : varchar(50)
    created_at : timestamp
    updated_at : timestamp
}

entity "other_costs" as other_costs {
    primary_key(id) : uuid
    --
    foreign_key(product_id) : uuid <<FK>>
    foreign_key(type_cost_id) : uuid <<FK>>
    not_null(cost) : decimal(15,2)
    created_at : timestamp
    updated_at : timestamp
}

entity "type_costs" as type_costs {
    primary_key(id) : uuid
    --
    not_null(name) : varchar(255)
    created_at : timestamp
    updated_at : timestamp
}

' === MATERIAL & INVENTORY ===
entity "materials" as materials {
    primary_key(id) : uuid
    --
    not_null(name) : varchar(255)
    status : varchar(50)
    minimum : decimal(15,4)
    description : text
    is_recipe : boolean
    not_null(is_active) : boolean
    created_at : timestamp
    updated_at : timestamp
}

entity "material_batches" as material_batches {
    primary_key(id) : uuid
    --
    foreign_key(material_id) : uuid <<FK>>
    not_null(quantity) : decimal(15,4)
    expired_at : date
    price : decimal(15,2)
    created_at : timestamp
    updated_at : timestamp
}

entity "material_details" as material_details {
    primary_key(id) : uuid
    --
    foreign_key(material_id) : uuid <<FK>>
    foreign_key(unit_id) : uuid <<FK>>
    base_quantity : decimal(15,4)
    created_at : timestamp
    updated_at : timestamp
}

entity "units" as units {
    primary_key(id) : uuid
    --
    not_null(name) : varchar(255)
    alias : varchar(20)
    group : varchar(50)
    foreign_key(base_unit_id) : uuid
    conversion_factor : decimal(20,10)
    created_at : timestamp
    updated_at : timestamp
}

entity "ingredient_categories" as ingredient_categories {
    primary_key(id) : uuid
    --
    not_null(name) : varchar(255)
    created_at : timestamp
    updated_at : timestamp
}

entity "ingredient_category_details" as ingredient_category_details {
    primary_key(id) : uuid
    --
    foreign_key(ingredient_category_id) : uuid <<FK>>
    foreign_key(material_id) : uuid <<FK>>
}

entity "inventory_logs" as inventory_logs {
    primary_key(id) : uuid
    --
    foreign_key(material_id) : uuid <<FK>>
    not_null(action) : varchar(50)
    not_null(type) : varchar(10)
    not_null(quantity) : decimal(15,4)
    reference_id : uuid
    reference_type : varchar(255)
    notes : text
    created_at : timestamp
    updated_at : timestamp
}

' === TRANSACTION ===
entity "transactions" as transactions {
    primary_key(id) : uuid
    --
    not_null(invoice_number) : varchar(50) <<unique>>
    foreign_key(user_id) : uuid <<FK>>
    foreign_key(customer_id) : uuid <<FK>>
    phone : varchar(20)
    schedule : datetime
    not_null(status) : varchar(50)
    not_null(payment_status) : varchar(50)
    method : varchar(50)
    not_null(total_amount) : decimal(15,2)
    points_used : integer
    points_discount : decimal(15,2)
    created_at : timestamp
    updated_at : timestamp
}

entity "transaction_details" as transaction_details {
    primary_key(id) : uuid
    --
    foreign_key(transaction_id) : uuid <<FK>>
    foreign_key(product_id) : uuid <<FK>>
    not_null(quantity) : integer
    not_null(price) : decimal(15,2)
    not_null(subtotal) : decimal(15,2)
    created_at : timestamp
    updated_at : timestamp
}

entity "payments" as payments {
    primary_key(id) : uuid
    --
    foreign_key(transaction_id) : uuid <<FK>>
    foreign_key(payment_channel_id) : uuid <<FK>>
    payment_method : varchar(50)
    not_null(paid_amount) : decimal(15,2)
    change_amount : decimal(15,2)
    created_at : timestamp
    updated_at : timestamp
}

entity "payment_channels" as payment_channels {
    primary_key(id) : uuid
    --
    not_null(name) : varchar(255)
    type : varchar(50)
    account_number : varchar(50)
    account_name : varchar(255)
    not_null(is_active) : boolean
    created_at : timestamp
    updated_at : timestamp
}

entity "refunds" as refunds {
    primary_key(id) : uuid
    --
    foreign_key(transaction_id) : uuid <<FK>>
    not_null(amount) : decimal(15,2)
    reason : text
    created_at : timestamp
    updated_at : timestamp
}

entity "shifts" as shifts {
    primary_key(id) : uuid
    --
    not_null(shift_number) : varchar(50)
    foreign_key(opened_by) : uuid <<FK>>
    foreign_key(closed_by) : uuid <<FK>>
    not_null(status) : varchar(20)
    not_null(initial_cash) : decimal(15,2)
    final_cash : decimal(15,2)
    expected_cash : decimal(15,2)
    created_at : timestamp
    updated_at : timestamp
}

' === PRODUCTION ===
entity "productions" as productions {
    primary_key(id) : uuid
    --
    not_null(production_number) : varchar(50) <<unique>>
    foreign_key(transaction_id) : uuid <<FK>>
    method : varchar(50)
    not_null(status) : varchar(50)
    is_start : boolean
    is_finish : boolean
    created_at : timestamp
    updated_at : timestamp
}

entity "production_details" as production_details {
    primary_key(id) : uuid
    --
    foreign_key(production_id) : uuid <<FK>>
    foreign_key(product_id) : uuid <<FK>>
    not_null(quantity) : integer
    created_at : timestamp
    updated_at : timestamp
}

entity "production_workers" as production_workers {
    primary_key(id) : uuid
    --
    foreign_key(production_id) : uuid <<FK>>
    foreign_key(user_id) : uuid <<FK>>
    created_at : timestamp
    updated_at : timestamp
}

' === EXPENSE ===
entity "expenses" as expenses {
    primary_key(id) : uuid
    --
    not_null(expense_number) : varchar(50) <<unique>>
    foreign_key(supplier_id) : uuid <<FK>>
    not_null(status) : varchar(50)
    grand_total_expect : decimal(15,2)
    grand_total_actual : decimal(15,2)
    created_at : timestamp
    updated_at : timestamp
}

entity "expense_details" as expense_details {
    primary_key(id) : uuid
    --
    foreign_key(expense_id) : uuid <<FK>>
    foreign_key(material_id) : uuid <<FK>>
    quantity_expect : decimal(15,4)
    quantity_actual : decimal(15,4)
    price_expect : decimal(15,2)
    price_actual : decimal(15,2)
    expired_at : date
    created_at : timestamp
    updated_at : timestamp
}

entity "suppliers" as suppliers {
    primary_key(id) : uuid
    --
    not_null(name) : varchar(255)
    phone : varchar(20)
    address : text
    created_at : timestamp
    updated_at : timestamp
}

' === HITUNG (STOCK COUNT) ===
entity "hitungs" as hitungs {
    primary_key(id) : uuid
    --
    not_null(hitung_number) : varchar(50) <<unique>>
    not_null(action) : varchar(50)
    not_null(status) : varchar(50)
    foreign_key(user_id) : uuid <<FK>>
    created_at : timestamp
    updated_at : timestamp
}

entity "hitung_details" as hitung_details {
    primary_key(id) : uuid
    --
    foreign_key(hitung_id) : uuid <<FK>>
    foreign_key(material_id) : uuid <<FK>>
    quantity_system : decimal(15,4)
    quantity_actual : decimal(15,4)
    created_at : timestamp
    updated_at : timestamp
}

' === STORE SETTINGS ===
entity "store_profiles" as store_profiles {
    primary_key(id) : uuid
    --
    name : varchar(255)
    description : text
    address : text
    phone : varchar(20)
    email : varchar(255)
    logo : varchar(255)
    created_at : timestamp
    updated_at : timestamp
}

entity "store_documents" as store_documents {
    primary_key(id) : uuid
    --
    not_null(name) : varchar(255)
    file_path : varchar(255)
    type : varchar(50)
    created_at : timestamp
    updated_at : timestamp
}

entity "activity_log" as activity_log {
    primary_key(id) : bigint
    --
    log_name : varchar(255)
    description : text
    subject_type : varchar(255)
    subject_id : varchar(255)
    causer_type : varchar(255)
    causer_id : varchar(255)
    properties : json
    created_at : timestamp
    updated_at : timestamp
}

' === RELATIONSHIPS ===

' User & Auth
users ||--o{ notifications : "has"
users ||--o{ model_has_roles : "has"
roles ||--o{ model_has_roles : "assigned to"
roles ||--o{ role_has_permissions : "has"
permissions ||--o{ role_has_permissions : "assigned to"

' Customer & Points
customers ||--o{ transactions : "makes"
customers ||--o{ points_histories : "has"
transactions ||--o{ points_histories : "generates"

' Product
categories ||--o{ products : "contains"
products ||--o{ product_categories : "has"
categories ||--o{ product_categories : "has"
products ||--o{ product_compositions : "composed of"
materials ||--o{ product_compositions : "used in"
products ||--o{ other_costs : "has"
type_costs ||--o{ other_costs : "categorizes"
products ||--o{ transaction_details : "ordered in"
products ||--o{ production_details : "produced in"

' Material & Inventory
materials ||--o{ material_batches : "has"
materials ||--o{ material_details : "has"
units ||--o{ material_details : "measured in"
units ||--o{ material_batches : "measured in"
units ||--o| units : "derived from (base_unit)"
ingredient_categories ||--o{ ingredient_category_details : "contains"
materials ||--o{ ingredient_category_details : "categorized in"
materials ||--o{ inventory_logs : "tracked in"
materials ||--o{ expense_details : "purchased in"
materials ||--o{ hitung_details : "counted in"

' Transaction
users ||--o{ transactions : "creates"
customers ||--o{ transactions : "belongs to"
transactions ||--o{ transaction_details : "contains"
transactions ||--o{ payments : "paid by"
payment_channels ||--o{ payments : "through"
transactions ||--o| refunds : "may have"
transactions ||--o| productions : "produces"
users ||--o{ shifts : "opens"
users ||--o{ shifts : "closes"

' Production
productions ||--o{ production_details : "contains"
productions ||--o{ production_workers : "worked by"
users ||--o{ production_workers : "works on"

' Expense
suppliers ||--o{ expenses : "supplies"
expenses ||--o{ expense_details : "contains"

' Hitung
users ||--o{ hitungs : "creates"
hitungs ||--o{ hitung_details : "contains"

@enduml
