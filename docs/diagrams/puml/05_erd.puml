@startuml ERD - Sistem Manajemen Toko Kue

!define table(x) entity x << (T,#FFAAAA) >>
!define primary_key(x) <b><u>x</u></b>
!define foreign_key(x) <i>x</i>
!define unique(x) <color:blue>x</color>

' ============================
' USER & AUTHENTICATION
' ============================
table(users) {
    primary_key(id): bigint
    --
    name: varchar(255)
    unique(email): varchar(255)
    password: varchar(255)
    phone: varchar(255)
    is_active: tinyint(1) default 0
    activated_at: timestamp null
    invitation_token: varchar(255) null
    remember_token: varchar(100)
    created_at: timestamp
    updated_at: timestamp
}

table(roles) {
    primary_key(id): bigint
    --
    name: varchar(255)
    guard_name: varchar(255)
    created_at: timestamp
    updated_at: timestamp
}

table(permissions) {
    primary_key(id): bigint
    --
    name: varchar(255)
    guard_name: varchar(255)
    created_at: timestamp
    updated_at: timestamp
}

table(model_has_roles) {
    foreign_key(role_id): bigint
    foreign_key(model_id): bigint
    model_type: varchar(255)
}

table(model_has_permissions) {
    foreign_key(permission_id): bigint
    foreign_key(model_id): bigint
    model_type: varchar(255)
}

table(role_has_permissions) {
    foreign_key(permission_id): bigint
    foreign_key(role_id): bigint
}

' ============================
' CUSTOMER & POINTS
' ============================
table(customers) {
    primary_key(id): bigint
    --
    name: varchar(255)
    unique(phone): varchar(20)
    address: text null
    points: int default 0
    is_active: tinyint(1) default 1
    created_at: timestamp
    updated_at: timestamp
}

table(points_histories) {
    primary_key(id): bigint
    --
    phone: varchar(20)
    action: enum('earn','redeem')
    points: int
    foreign_key(transaction_id): bigint null
    created_at: timestamp
}

' ============================
' PRODUCT MANAGEMENT
' ============================
table(categories) {
    primary_key(id): bigint
    --
    name: varchar(255)
    is_active: tinyint(1) default 1
    created_at: timestamp
    updated_at: timestamp
}

table(products) {
    primary_key(id): bigint
    --
    foreign_key(category_id): bigint
    unique(code): varchar(50)
    name: varchar(255)
    image: varchar(255) null
    description: text null
    stock: int default 0
    price: decimal(15,2)
    is_ready: tinyint(1) default 0
    is_active: tinyint(1) default 1
    created_at: timestamp
    updated_at: timestamp
}

table(product_compositions) {
    primary_key(id): bigint
    --
    foreign_key(product_id): bigint
    foreign_key(material_id): bigint
    quantity: decimal(10,3)
    created_at: timestamp
    updated_at: timestamp
}

' ============================
' MATERIAL & INVENTORY
' ============================
table(ingredient_categories) {
    primary_key(id): bigint
    --
    name: varchar(255)
    is_active: tinyint(1) default 1
    created_at: timestamp
    updated_at: timestamp
}

table(units) {
    primary_key(id): bigint
    --
    name: varchar(100)
    is_active: tinyint(1) default 1
    created_at: timestamp
    updated_at: timestamp
}

table(materials) {
    primary_key(id): bigint
    --
    foreign_key(ingredient_category_id): bigint
    foreign_key(unit_id): bigint
    unique(code): varchar(50)
    name: varchar(255)
    image: varchar(255) null
    description: text null
    is_active: tinyint(1) default 1
    created_at: timestamp
    updated_at: timestamp
}

table(material_batches) {
    primary_key(id): bigint
    --
    foreign_key(material_id): bigint
    batch_number: varchar(100)
    date: date
    batch_quantity: decimal(10,3)
    created_at: timestamp
    updated_at: timestamp
}

table(inventory_logs) {
    primary_key(id): bigint
    --
    foreign_key(material_id): bigint
    action: enum('in','out','adjustment','damaged','lost')
    quantity_change: decimal(10,3)
    reference_type: varchar(255) null
    reference_id: bigint null
    created_at: timestamp
}

' ============================
' TRANSACTION
' ============================
table(shifts) {
    primary_key(id): bigint
    --
    unique(shift_number): varchar(50)
    foreign_key(opened_by): bigint
    foreign_key(closed_by): bigint null
    start_time: timestamp
    end_time: timestamp null
    initial_cash: decimal(15,2)
    final_cash: decimal(15,2) null
    total_sales: decimal(15,2) null
    total_refunds: decimal(15,2) null
    status: enum('Buka','Tutup') default 'Buka'
    created_at: timestamp
    updated_at: timestamp
}

table(transactions) {
    primary_key(id): bigint
    --
    unique(invoice_number): varchar(50)
    foreign_key(customer_id): bigint null
    method: enum('siap-beli','pesanan-reguler','pesanan-kotak')
    status: enum('Antrian','Proses','Dapat Diambil','Selesai','Dibatalkan')
    payment_status: enum('Belum Bayar','DP','Lunas') default 'Belum Bayar'
    schedule: datetime null
    total_amount: decimal(15,2)
    total_refund: decimal(15,2) default 0
    note: text null
    foreign_key(created_by_shift): bigint null
    foreign_key(refund_by_shift): bigint null
    created_at: timestamp
    updated_at: timestamp
}

table(transaction_details) {
    primary_key(id): bigint
    --
    foreign_key(transaction_id): bigint
    foreign_key(product_id): bigint
    quantity: int
    unit_price: decimal(15,2)
    sub_total: decimal(15,2)
    created_at: timestamp
    updated_at: timestamp
}

table(payment_channels) {
    primary_key(id): bigint
    --
    name: varchar(255)
    type: enum('Bank','E-Wallet')
    account_number: varchar(100) null
    account_name: varchar(255) null
    is_active: tinyint(1) default 1
    created_at: timestamp
    updated_at: timestamp
}

table(payments) {
    primary_key(id): bigint
    --
    foreign_key(transaction_id): bigint
    payment_method: varchar(50)
    foreign_key(payment_channel_id): bigint null
    paid_amount: decimal(15,2)
    receipt_number: varchar(100) null
    proof_image: varchar(255) null
    created_at: timestamp
    updated_at: timestamp
}

table(refunds) {
    primary_key(id): bigint
    --
    foreign_key(transaction_id): bigint
    reason: text
    refund_method: varchar(50)
    foreign_key(payment_channel_id): bigint null
    account_number: varchar(100) null
    total_amount: decimal(15,2)
    proof_image: varchar(255) null
    foreign_key(refund_by_shift): bigint null
    refunded_at: timestamp
    created_at: timestamp
    updated_at: timestamp
}

' ============================
' PRODUCTION
' ============================
table(productions) {
    primary_key(id): bigint
    --
    unique(production_number): varchar(50)
    foreign_key(transaction_id): bigint null
    method: enum('pesanan-reguler','pesanan-kotak','siap-beli')
    status: enum('Antrian','Proses','Selesai','Batal')
    foreign_key(worker_id): bigint null
    is_start: tinyint(1) default 0
    is_finish: tinyint(1) default 0
    start_date: datetime null
    end_date: datetime null
    created_at: timestamp
    updated_at: timestamp
}

table(production_details) {
    primary_key(id): bigint
    --
    foreign_key(production_id): bigint
    foreign_key(product_id): bigint
    quantity_expect: int
    quantity_get: int null
    quantity_fail: int null
    created_at: timestamp
    updated_at: timestamp
}

' ============================
' EXPENSE (BELANJA)
' ============================
table(suppliers) {
    primary_key(id): bigint
    --
    name: varchar(255)
    phone: varchar(20) null
    address: text null
    is_active: tinyint(1) default 1
    created_at: timestamp
    updated_at: timestamp
}

table(expenses) {
    primary_key(id): bigint
    --
    unique(expense_number): varchar(50)
    foreign_key(supplier_id): bigint
    status: enum('Rencana','Proses','Selesai','Batal')
    is_start: tinyint(1) default 0
    is_finish: tinyint(1) default 0
    grand_total_expect: decimal(15,2) default 0
    grand_total_actual: decimal(15,2) default 0
    created_at: timestamp
    updated_at: timestamp
}

table(expense_details) {
    primary_key(id): bigint
    --
    foreign_key(expense_id): bigint
    foreign_key(material_id): bigint
    quantity_expect: decimal(10,3)
    quantity_get: decimal(10,3) null
    price_expect: decimal(15,2)
    price_get: decimal(15,2) null
    total_expect: decimal(15,2)
    total_actual: decimal(15,2) null
    expiry_date: date null
    is_quantity_get: tinyint(1) default 0
    created_at: timestamp
    updated_at: timestamp
}

' ============================
' STOCK COUNT (HITUNG)
' ============================
table(hitungs) {
    primary_key(id): bigint
    --
    unique(hitung_number): varchar(50)
    foreign_key(user_id): bigint
    action: enum('hitung','rusak','hilang')
    status: enum('Rencana','Proses','Selesai','Batal')
    is_start: tinyint(1) default 0
    is_finish: tinyint(1) default 0
    hitung_date: datetime null
    hitung_date_finish: datetime null
    grand_total: decimal(15,2) default 0
    loss_grand_total: decimal(15,2) default 0
    created_at: timestamp
    updated_at: timestamp
}

table(hitung_details) {
    primary_key(id): bigint
    --
    foreign_key(hitung_id): bigint
    foreign_key(material_id): bigint
    quantity_expect: decimal(10,3)
    quantity_actual: decimal(10,3) null
    total: decimal(15,2) null
    loss_total: decimal(15,2) null
    created_at: timestamp
    updated_at: timestamp
}

' ============================
' STORE SETTINGS
' ============================
table(store_settings) {
    primary_key(id): bigint
    --
    unique(key): varchar(255)
    value: text null
    type: enum('text','number','boolean','json')
    created_at: timestamp
    updated_at: timestamp
}

table(type_costs) {
    primary_key(id): bigint
    --
    name: varchar(255)
    is_active: tinyint(1) default 1
    created_at: timestamp
    updated_at: timestamp
}

table(store_documents) {
    primary_key(id): bigint
    --
    foreign_key(type_cost_id): bigint
    document_number: varchar(100)
    document_name: varchar(255)
    nominal: decimal(15,2)
    started_date: date
    ended_date: date
    file_path: varchar(255) null
    status: enum('Aktif','Berakhir','Habis') default 'Aktif'
    created_at: timestamp
    updated_at: timestamp
}

table(notifications) {
    primary_key(id): char(36)
    --
    type: varchar(255)
    notifiable_type: varchar(255)
    notifiable_id: bigint
    data: text
    read_at: timestamp null
    created_at: timestamp
    updated_at: timestamp
}

table(sessions) {
    primary_key(id): varchar(255)
    --
    user_id: bigint null
    ip_address: varchar(45) null
    user_agent: text null
    payload: longtext
    last_activity: int
}

table(cache) {
    primary_key(key): varchar(255)
    --
    value: mediumtext
    expiration: int
}

table(cache_locks) {
    primary_key(key): varchar(255)
    --
    owner: varchar(255)
    expiration: int
}

table(jobs) {
    primary_key(id): bigint
    --
    queue: varchar(255)
    payload: longtext
    attempts: tinyint
    reserved_at: int null
    available_at: int
    created_at: int
}

table(job_batches) {
    primary_key(id): varchar(255)
    --
    name: varchar(255)
    total_jobs: int
    pending_jobs: int
    failed_jobs: int
    failed_job_ids: longtext
    options: mediumtext null
    cancelled_at: int null
    created_at: int
    finished_at: int null
}

table(failed_jobs) {
    primary_key(id): bigint
    --
    uuid: varchar(255) unique
    connection: text
    queue: text
    payload: longtext
    exception: longtext
    failed_at: timestamp
}

' ============================
' RELATIONSHIPS
' ============================

' User & Auth
users ||--o{ model_has_roles : has
roles ||--o{ model_has_roles : assigned
roles ||--o{ role_has_permissions : has
permissions ||--o{ role_has_permissions : granted
permissions ||--o{ model_has_permissions : granted
users ||--o{ model_has_permissions : has

' Customer & Points
customers ||--o{ transactions : makes
customers ||--o{ points_histories : earns/redeems
transactions ||--o{ points_histories : generates

' Product
categories ||--o{ products : contains
products ||--o{ product_compositions : has
materials ||--o{ product_compositions : used_in

' Material & Inventory
ingredient_categories ||--o{ materials : groups
units ||--o{ materials : measures
materials ||--o{ material_batches : has
materials ||--o{ inventory_logs : tracks

' Transaction
users ||--o{ shifts : manages
shifts ||--o{ transactions : contains
transactions ||--o{ transaction_details : has
products ||--o{ transaction_details : sold_in
transactions ||--o{ payments : has
payment_channels ||--o{ payments : processes
transactions ||--o{ refunds : may_have
payment_channels ||--o{ refunds : processes

' Production
transactions ||--o{ productions : triggers
users ||--o{ productions : works_on
productions ||--o{ production_details : has
products ||--o{ production_details : produced

' Expense
suppliers ||--o{ expenses : supplies
expenses ||--o{ expense_details : contains
materials ||--o{ expense_details : purchased

' Stock Count
users ||--o{ hitungs : performs
hitungs ||--o{ hitung_details : contains
materials ||--o{ hitung_details : counted

' Store Settings
type_costs ||--o{ store_documents : categorizes

@enduml
