@startuml Sequence Diagram - Mengelola Pekerja

actor Pemilik
participant "User Page\n(Livewire)" as Page
participant "User\nModel" as User
participant "SpatieRole\nModel" as Role
participant "Mail\nFacade" as Mail
participant "Notification" as Notif
database Database as DB

== Menambah Pekerja (Undangan) ==
Pemilik -> Page: Klik "Tambah Pekerja"

Page -> Role: all()
Role -> DB: SELECT * FROM roles
DB --> Role: roles list
Role --> Page: available roles

Page --> Pemilik: Tampilkan form dengan pilihan role

Pemilik -> Page: Isi data pekerja
note right
  - Nama
  - Email
  - Nomor telepon
  - Jenis kelamin
  - Foto (opsional)
  (tanpa password)
end note

Pemilik -> Page: Pilih role (wajib)
Pemilik -> Page: Simpan

Page -> User: where('email', email)->exists()
User -> DB: SELECT * FROM users WHERE email = ?
DB --> User: exists check

alt Email sudah terdaftar
    Page --> Pemilik: Error: Email sudah digunakan
else Email baru
    Page -> User: create(userData)
    note right
      is_active = false
      password = random hash
      invitation_token = generated
      invitation_expires_at = now + 7 days
    end note
    User -> DB: INSERT INTO users
    DB --> User: user created
    
    Page -> User: assignRole(selectedRole)
    User -> DB: INSERT INTO model_has_roles
    DB --> User: role assigned
    
    Page -> Mail: send(UserInvitationNotification)
    Mail -> Notif: via('mail')
    Notif --> Mail: email queued
    
    Page --> Pemilik: Pekerja berhasil ditambahkan\nEmail undangan terkirim
end

== Kirim Ulang Undangan ==
Pemilik -> Page: Pilih pekerja belum aktivasi
Pemilik -> Page: Klik "Kirim Ulang Undangan"

Page -> User: generateInvitationToken()
User -> DB: UPDATE invitation_token, expires_at
DB --> User: updated

Page -> Mail: send(UserInvitationNotification)
Mail --> Page: sent

Page --> Pemilik: Undangan terkirim ulang

== Toggle Aktif/Nonaktif ==
Pemilik -> Page: Klik toggle status
Page -> User: find(id)

alt Status saat ini Aktif
    Page -> User: update(['is_active' => false])
    User -> DB: UPDATE is_active = false
    Page --> Pemilik: Pekerja dinonaktifkan
    note right: Pekerja tidak bisa login
else Status saat ini Nonaktif
    Page -> User: update(['is_active' => true])
    User -> DB: UPDATE is_active = true
    Page --> Pemilik: Pekerja diaktifkan kembali
end

== Melihat Detail Pekerja ==
Pemilik -> Page: Pilih pekerja
Page -> User: find(id)->with('roles')
User -> DB: SELECT dengan relasi roles
DB --> User: user with roles

Page -> Role: getPermissions()
Role -> DB: SELECT permissions via role_has_permissions
DB --> Role: permissions list

Page --> Pemilik: Tampilkan detail pekerja
note right
  - Info pekerja
  - Status: Aktif/Nonaktif/Menunggu Aktivasi
  - Role yang dimiliki
  - Permission yang didapat
end note

== Mengedit Pekerja ==
Pemilik -> Page: Pilih edit
Page -> User: find(id)->with('roles')
User --> Page: user data
Page --> Pemilik: Tampilkan form edit

Pemilik -> Page: Ubah data
Pemilik -> Page: Ubah role (opsional)
Pemilik -> Page: Simpan

Page -> User: update(data)
User -> DB: UPDATE users
DB --> User: updated

alt Role berubah
    Page -> User: syncRoles([newRole])
    User -> DB: DELETE FROM model_has_roles WHERE model_id = ?
    User -> DB: INSERT INTO model_has_roles
    DB --> User: role synced
end

Page --> Pemilik: Pekerja berhasil diupdate

== Menghapus Pekerja ==
Pemilik -> Page: Pilih hapus
Page --> Pemilik: Konfirmasi hapus?
Pemilik -> Page: Konfirmasi

Page -> User: checkUsage(id)
User -> DB: SELECT FROM transactions WHERE user_id = ?
User -> DB: SELECT FROM productions WHERE user involves

alt Pekerja punya aktivitas
    Page --> Pemilik: Peringatan: Akan dinonaktifkan
    Page -> User: update(['is_active' => false])
    User -> DB: UPDATE users SET is_active = false
else Tidak ada aktivitas
    Page -> User: delete(id)
    User -> DB: DELETE FROM users
    User -> DB: DELETE FROM model_has_roles WHERE model_id = ?
end

Page --> Pemilik: Pekerja berhasil dihapus

@enduml
