@startuml

skinparam classAttributeIconSize 0
skinparam linetype ortho
hide empty members

title Class Diagram - Increment 2\nModul Pendukung Operasional

' ==========================================
' EXTENSION KELAS INCREMENT 1
' ==========================================

package "Extension: Autentikasi" #LightBlue {
    class User <<Extension>> {
        -invitation_token: String
        -invitation_sent_at: Timestamp
        -activated_at: Timestamp
        --
        +sendInvitation(): void
        +activateWithPassword(password): void
        +hasValidInvitationToken(): Boolean
    }
    
    note right of User
        Extension dari User Increment 1
        Menambahkan field & method
        untuk aktivasi akun (UC-17)
    end note
}

package "Extension: Pelanggan & Poin" #LightGreen {
    class Customer <<Extension>> {
        -points: Decimal
        --
        +pointsHistories(): HasMany
        +addPoints(amount): void
        +usePoints(amount): Boolean
    }
    
    note right of Customer
        Extension dari Customer Increment 1
        Menambahkan field points
        dan manajemen poin (UC-15, UC-20)
    end note

    class PointsHistory {
        -id: UUID
        -phone: String
        -transaction_id: UUID
        -action_id: String
        -action: String
        -points: Integer
        -image: String
        --
        +customer(): BelongsTo
        +transaction(): BelongsTo
    }
    
    class Notification {
        -id: UUID
        -user_id: UUID
        -title: String
        -body: Text
        -type: String
        -is_read: Boolean
        -status: TinyInteger
        --
        +markAsRead(): void
        +user(): BelongsTo
    }
}

package "Extension: Transaksi" #LightPink {
    class Transaction <<Extension>> {
        -points_used: Integer
        -points_discount: Decimal
        -total_refund: Decimal
        --
        +refund(): HasOne
        +pointsHistories(): HasMany
    }
    
    note right of Transaction
        Extension dari Transaction Increment 1
        Menambahkan field untuk poin (UC-20)
        dan refund (UC-21)
    end note

    class TransactionDetail <<Extension>> {
        -refund_quantity: SmallInteger
        --
        +getRemainingQuantity(): Integer
    }
    
    note right of TransactionDetail
        Extension dari TransactionDetail Increment 1
        Menambahkan field refund_quantity (UC-21)
    end note

    class Shift <<Extension>> {
        -total_refunds: Decimal
        -total_discounts: Decimal
        --
        +calculateTotals(): void
    }
    
    note right of Shift
        Extension dari Shift Increment 1
        Menambahkan field refund & discount
        dari fitur UC-20 dan UC-21
    end note
}

' ==========================================
' KELAS BARU INCREMENT 2
' ==========================================

package "Inventori: Stock Opname & Tracking" #Wheat {
    class Hitung {
        -id: UUID
        -user_id: UUID
        -hitung_number: String
        -action: String
        -note: String
        -status: String
        -hitung_date: Date
        -hitung_date_finish: Date
        -is_start: Boolean
        -is_finish: Boolean
        -grand_total: Decimal
        -loss_grand_total: Decimal
        --
        +user(): BelongsTo
        +details(): HasMany
        +generateHitungNumber(): String
    }

    class HitungDetail {
        -id: UUID
        -hitung_id: UUID
        -material_id: UUID
        -unit_id: UUID
        -quantity_system: Decimal
        -quantity_actual: Decimal
        -quantity_difference: Decimal
        -price: Decimal
        -total_loss: Decimal
        --
        +hitung(): BelongsTo
        +material(): BelongsTo
        +unit(): BelongsTo
    }
    
    class InventoryLog {
        -id: UUID
        -material_id: UUID
        -material_batch_id: UUID
        -user_id: UUID
        -action: String
        -quantity_change: Decimal
        -quantity_after: Decimal
        -reference_type: String
        -reference_id: String
        -note: Text
        --
        +material(): BelongsTo
        +batch(): BelongsTo
        +user(): BelongsTo
    }
}

package "Refund" #MistyRose {
    class Refund {
        -id: UUID
        -transaction_id: UUID
        -reason: String
        -proof_image: String
        -refund_method: String
        -payment_channel_id: UUID
        -account_number: String
        -total_amount: Decimal
        -refund_by_shift: UUID
        -refunded_at: DateTime
        --
        +transaction(): BelongsTo
        +paymentChannel(): BelongsTo
        +shift(): BelongsTo
    }
}

package "Pengaturan" #LightGray {
    class StoreProfile {
        -id: UUID
        -logo: String
        -name: String
        -tagline: String
        -type: String
        -banner: String
        -product: String
        -description: Text
        -building: String
        -location: String
        -address: String
        -contact: String
        -email: String
        -website: String
        -social_instagram: String
        -social_facebook: String
        -social_whatsapp: String
    }

    class StoreDocument {
        -id: UUID
        -document_name: String
        -document_number: String
        -document_file: String
        -valid_from: Date
        -valid_until: Date
    }

    class ActivityLog {
        -id: BigInteger
        -log_name: String
        -description: Text
        -subject_type: String
        -subject_id: UUID
        -causer_type: String
        -causer_id: UUID
        -properties: JSON
        -event: String
        -batch_uuid: UUID
    }
}

' ==========================================
' RELASI
' ==========================================

Customer "1" -- "*" PointsHistory
Transaction "1" -- "*" PointsHistory
Transaction "1" -- "0..1" Refund

User "1" -- "*" Notification
User "1" -- "*" Hitung
User "1" -- "*" InventoryLog

Hitung "1" -- "*" HitungDetail

@enduml

' ==========================================
' KELAS BARU INCREMENT 2
' ==========================================

package "Inventori: Stock Opname" #Wheat {
    class Material {
        -id: UUID
        -name: String
        -description: String
        -image: String
        -expiry_date: Date
        -status: String
        -is_active: Boolean
        -is_recipe: Boolean
        -minimum: Decimal
        --
        +getTotalQuantityInUnit(unit): Float
        +reduceQuantity(qty, unit): Boolean
        +getUnitPriceInUnit(unit): Float
        +recalculateStatus(): void
        +batches(): HasMany
        +material_details(): HasMany
    }

    class MaterialDetail {
        -id: UUID
        -material_id: UUID
        -unit_id: UUID
        -price: Decimal
        -is_main: Boolean
        --
        +material(): BelongsTo
        +unit(): BelongsTo
    }

    class MaterialBatch {
        -id: UUID
        -material_id: UUID
        -unit_id: UUID
        -batch_number: String
        -date: Date
        -batch_quantity: Decimal
        --
        +material(): BelongsTo
        +unit(): BelongsTo
        +inventoryLogs(): HasMany
    }

    class ProductComposition {
        -id: UUID
        -product_id: UUID
        -material_id: UUID
        -unit_id: UUID
        -material_quantity: Decimal
        --
        +product(): BelongsTo
        +material(): BelongsTo
        +unit(): BelongsTo
    }

    class IngredientCategory {
        -id: UUID
        -name: String
        -description: String
        --
        +details(): HasMany
        +materials(): BelongsToMany
    }

    class IngredientCategoryDetail {
        -id: UUID
        -ingredient_category_id: UUID
        -material_id: UUID
        --
        +ingredientCategory(): BelongsTo
        +material(): BelongsTo
    }

    class InventoryLog {
        -id: UUID
        -material_id: UUID
        -material_batch_id: UUID
        -user_id: UUID
        -action: String
        -quantity_change: Decimal
        -quantity_after: Decimal
        -reference_type: String
        -reference_id: String
        -note: Text
        --
        +material(): BelongsTo
        +batch(): BelongsTo
        +user(): BelongsTo
    }
}

package "Supplier & Belanja" #Lavender {
    class Supplier {
        -id: UUID
        -name: String
        -description: String
        -contact_name: String
        -phone: String
        -street: String
        -landmark: String
        -maps_link: String
        -image: String
        --
        +expenses(): HasMany
    }

    class Expense {
        -id: UUID
        -expense_number: String
        -expense_date: Date
        -end_date: Date
        -supplier_id: UUID
        -note: String
        -status: String
        -grand_total_expect: Decimal
        -grand_total_actual: Decimal
        -is_start: Boolean
        -is_finish: Boolean
        --
        +supplier(): BelongsTo
        +expenseDetails(): HasMany
        +generateExpenseNumber(): String
    }

    class ExpenseDetail {
        -id: UUID
        -expense_id: UUID
        -material_id: UUID
        -unit_id: UUID
        -quantity_expect: Decimal
        -quantity_get: Decimal
        -is_quantity_get: Boolean
        -price_expect: Decimal
        -price_get: Decimal
        -total_expect: Decimal
        -total_actual: Decimal
        -expiry_date: Date
        --
        +expense(): BelongsTo
        +material(): BelongsTo
        +unit(): BelongsTo
    }
}

package "Produksi" #PaleGreen {
    class Production {
        -id: UUID
        -production_number: String
        -transaction_id: UUID
        -method: String
        -date: Date
        -time: Time
        -start_date: Date
        -end_date: Date
        -note: String
        -status: String
        -is_start: Boolean
        -is_finish: Boolean
        --
        +transaction(): BelongsTo
        +details(): HasMany
        +workers(): HasMany
        +generateProductionNumber(): String
    }

    class ProductionDetail {
        -id: UUID
        -production_id: UUID
        -product_id: UUID
        -quantity_plan: Decimal
        -quantity_get: Decimal
        -quantity_fail: Decimal
        -cycle: Decimal
        --
        +production(): BelongsTo
        +product(): BelongsTo
    }

    class ProductionWorker {
        -id: UUID
        -production_id: UUID
        -user_id: UUID
        --
        +production(): BelongsTo
        +user(): BelongsTo
    }
}

package "Stock Opname" #Wheat {
    class Hitung {
        -id: UUID
        -user_id: UUID
        -hitung_number: String
        -action: String
        -note: String
        -status: String
        -hitung_date: Date
        -hitung_date_finish: Date
        -is_start: Boolean
        -is_finish: Boolean
        -grand_total: Decimal
        -loss_grand_total: Decimal
        --
        +user(): BelongsTo
        +details(): HasMany
        +generateHitungNumber(): String
    }

    class HitungDetail {
        -id: UUID
        -hitung_id: UUID
        -material_id: UUID
        -unit_id: UUID
        -quantity_system: Decimal
        -quantity_actual: Decimal
        -quantity_difference: Decimal
        -price: Decimal
        -total_loss: Decimal
        --
        +hitung(): BelongsTo
        +material(): BelongsTo
        +unit(): BelongsTo
    }
}

package "Refund" #MistyRose {
    class Refund {
        -id: UUID
        -transaction_id: UUID
        -reason: String
        -proof_image: String
        -refund_method: String
        -payment_channel_id: UUID
        -account_number: String
        -total_amount: Decimal
        -refund_by_shift: UUID
        -refunded_at: DateTime
        --
        +transaction(): BelongsTo
        +paymentChannel(): BelongsTo
        +shift(): BelongsTo
    }
}

package "Pengaturan" #LightGray {
    class StoreProfile {
        -id: UUID
        -logo: String
        -name: String
        -tagline: String
        -type: String
        -banner: String
        -product: String
        -description: Text
        -building: String
        -location: String
        -address: String
        -contact: String
        -email: String
        -website: String
        -social_instagram: String
        -social_facebook: String
        -social_whatsapp: String
    }

    class StoreDocument {
        -id: UUID
        -document_name: String
        -document_number: String
        -document_file: String
        -valid_from: Date
        -valid_until: Date
    }

    class ActivityLog {
        -id: BigInteger
        -log_name: String
        -description: Text
        -subject_type: String
        -subject_id: UUID
        -causer_type: String
        -causer_id: UUID
        -properties: JSON
        -event: String
        -batch_uuid: UUID
    }
}

' ==========================================
' RELASI
' ==========================================

Material "1" -- "*" MaterialDetail
Material "1" -- "*" MaterialBatch
Material "1" -- "*" ProductComposition
Material "1" -- "*" ExpenseDetail
Material "1" -- "*" IngredientCategoryDetail
Material "1" -- "*" HitungDetail
Material "1" -- "*" InventoryLog
MaterialBatch "1" -- "*" InventoryLog

IngredientCategory "1" -- "*" IngredientCategoryDetail

Supplier "1" -- "*" Expense
Expense "1" -- "*" ExpenseDetail

Production "1" -- "*" ProductionDetail
Production "1" -- "*" ProductionWorker

Hitung "1" -- "*" HitungDetail

@enduml
