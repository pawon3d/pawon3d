@startuml Sequence Diagram - Proses Belanja

actor Inventori as User
participant "Expense Page\n(Livewire)" as ExpPage
participant "Expense\nModel" as Expense
participant "ExpenseDetail\nModel" as ExpDetail
participant "Material\nModel" as Material
participant "MaterialBatch\nModel" as Batch
participant "InventoryLog\nModel" as Log
participant "NotificationService" as Notif
database Database as DB

== Membuat Rencana Belanja ==
User -> ExpPage: Buka halaman tambah belanja
User -> ExpPage: Pilih supplier
User -> ExpPage: Tambah bahan baku dan jumlah

ExpPage -> Expense: create(expense_data)
note right
  expense_number: auto-generate
  status: 'Rencana'
  grand_total_expect: total perkiraan
end note
Expense -> DB: INSERT INTO expenses
DB --> Expense: expense

ExpPage -> ExpDetail: createMany(details)
loop Untuk setiap bahan
    ExpDetail -> DB: INSERT INTO expense_details
    note right
      quantity_expect: jumlah rencana
      price_expect: harga perkiraan
    end note
end
DB --> ExpDetail: details

ExpPage -> Notif: expensePlanned(expense_number)
Notif -> DB: INSERT INTO notifications

ExpPage --> User: Rencana belanja tersimpan

== Memulai Belanja ==
User -> ExpPage: Pilih belanja dan mulai
ExpPage -> Expense: update(['status' => 'Proses'])
Expense -> DB: UPDATE expenses
DB --> Expense: updated

ExpPage -> Notif: expenseProcessing(expense_number)
Notif -> DB: INSERT INTO notifications

ExpPage --> User: Belanja dimulai

== Menyelesaikan Belanja ==
User -> ExpPage: Isi jumlah aktual tiap bahan
User -> ExpPage: Isi harga aktual tiap bahan
User -> ExpPage: Isi tanggal expired (opsional)

loop Untuk setiap detail
    ExpPage -> ExpDetail: update(actual_data)
    note right
      quantity_actual: jumlah real
      price_actual: harga real
      expired_at: tanggal expired
    end note
    ExpDetail -> DB: UPDATE expense_details
end

User -> ExpPage: Selesaikan belanja

== Buat Batch Baru ==
loop Untuk setiap bahan
    ExpPage -> Batch: create(batch_data)
    note right
      material_id
      quantity: jumlah aktual
      expired_at
      price: harga per unit
    end note
    Batch -> DB: INSERT INTO material_batches
    DB --> Batch: batch created
    
    ExpPage -> Log: create(log_data)
    note right
      action: 'belanja'
      type: 'in'
    end note
    Log -> DB: INSERT INTO inventory_logs
end

== Update Status Bahan ==
loop Untuk setiap bahan
    ExpPage -> Material: Hitung total stok
    ExpPage -> Material: update(['status' => 'Tersedia'])
    Material -> DB: UPDATE materials
end

== Update Expense ==
ExpPage -> Expense: update(final_data)
note right
  status: 'Selesai'
  grand_total_actual: total aktual
end note
Expense -> DB: UPDATE expenses
DB --> Expense: updated

ExpPage -> Notif: expenseCompleted(expense_number)
Notif -> DB: INSERT INTO notifications

ExpPage --> User: Belanja selesai, stok terupdate

@enduml
