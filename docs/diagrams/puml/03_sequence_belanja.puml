@startuml Sequence - Belanja Bahan Baku

actor Inventori
participant "Expense Page\n(Livewire)" as Page
participant Expense
participant ExpenseDetail
participant MaterialBatch
participant InventoryLog
participant Notification as Notif
database DB

== Buat Rencana ==
Inventori -> Page: GET /belanja/tambah
Inventori -> Page: Pilih supplier, bahan,\nqty expect, price expect

Page -> Expense: create(expense_number,\nsupplier_id,\nstatus="Rencana",\ngrand_total_expect)
Expense -> DB: INSERT expenses
DB --> Expense: expense

Page -> ExpenseDetail: createMany(items)
ExpenseDetail -> DB: INSERT expense_details

Page --> Inventori: Rencana tersimpan

== Mulai Belanja ==
Inventori -> Page: GET /belanja/{id}/dapatkan-belanja
Inventori -> Page: Klik "Mulai"

Page -> Expense: update(status="Proses",\nis_start=true)
Expense -> DB: UPDATE expenses

== Input Hasil Aktual ==
Inventori -> Page: Input qty_get,\nprice_get,\nexpiry_date per item

Page -> ExpenseDetail: update(quantity_get,\nprice_get,\ntotal_actual,\nexpiry_date,\nis_quantity_get=true)
ExpenseDetail -> DB: UPDATE expense_details

== Selesaikan Belanja ==
Inventori -> Page: Klik "Selesaikan"

loop setiap detail
    Page -> MaterialBatch: create(material_id,\nbatch_number,\ndate=expiry_date,\nbatch_quantity=qty_get)
    MaterialBatch -> DB: INSERT material_batches
    
    Page -> InventoryLog: create(action="in",\nreference_type="Expense",\nquantity_change=qty_get)
    InventoryLog -> DB: INSERT inventory_logs
end

Page -> Expense: update(status="Selesai",\nis_finish=true,\ngrand_total_actual=sum)
Expense -> DB: UPDATE expenses

Page -> Notif: expenseCompleted(expense_number)
Notif -> DB: INSERT notifications

Page --> Inventori: Belanja selesai

@enduml
