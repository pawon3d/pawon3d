@startuml Sequence Diagram - Mengelola Bahan Baku

actor Inventori
participant "Material Page\n(Livewire)" as Page
participant "Material\nModel" as Material
participant "MaterialDetail\nModel" as Detail
participant "MaterialBatch\nModel" as Batch
participant "InventoryLog\nModel" as Log
participant "Unit\nModel" as Unit
database Database as DB

== Menambah Bahan Baku ==
Inventori -> Page: Klik "Tambah Bahan"
Page --> Inventori: Tampilkan form bahan

Inventori -> Page: Isi data bahan
note right
  - Nama bahan
  - Kategori
  - Stok minimum
  - Deskripsi
end note

Inventori -> Page: Tambah satuan

loop Untuk setiap satuan
    Inventori -> Page: Pilih unit
    Page -> Unit: all()
    Unit -> DB: SELECT * FROM units
    DB --> Unit: units list
    Unit --> Page: available units
    
    Inventori -> Page: Masukkan kuantitas dasar
    Inventori -> Page: Tandai satuan utama (opsional)
    Page -> Page: Tambah ke array satuan
end

Inventori -> Page: Simpan bahan

Page -> Material: create(materialData)
Material -> DB: INSERT INTO materials
note right
  status = 'Kosong'
  is_active = true
end note
DB --> Material: material created

loop Untuk setiap satuan
    Page -> Detail: create(detailData)
    Detail -> DB: INSERT INTO material_details
end

Page --> Inventori: Bahan berhasil ditambahkan

== Melihat Batch Bahan ==
Inventori -> Page: Pilih bahan
Page -> Batch: where('material_id', id)->orderBy('expired_at')
Batch -> DB: SELECT * FROM material_batches ORDER BY expired_at (FIFO)
DB --> Batch: batches list
Batch --> Page: batches data

Page --> Inventori: Tampilkan daftar batch
note right
  Info batch:
  - Qty tersisa
  - Tanggal expired
  - Harga beli
  - Tanggal masuk
end note

== Melihat Alur Pergerakan Stok ==
Inventori -> Page: Klik "Lihat Alur"
Page -> Log: where('material_id', id)->latest()
Log -> DB: SELECT * FROM inventory_logs ORDER BY created_at DESC
DB --> Log: logs list
Log --> Page: inventory logs

Page --> Inventori: Tampilkan riwayat pergerakan
note right
  Jenis pergerakan:
  - IN: Dari belanja
  - OUT: Untuk produksi
  - ADJ: Penyesuaian stok
  - LOSS: Rusak/Hilang
end note

== Mengedit Bahan ==
Inventori -> Page: Pilih edit bahan
Page -> Material: find(id)->with('material_details')
Material -> DB: SELECT dengan relasi
DB --> Material: material data
Material --> Page: material with details

Inventori -> Page: Ubah data
Inventori -> Page: Simpan

Page -> Material: update(data)
Material -> DB: UPDATE materials
DB --> Material: updated

Page -> Detail: sync(newDetails)
Detail -> DB: DELETE & INSERT material_details

Page --> Inventori: Bahan berhasil diupdate

== Menghapus Bahan ==
Inventori -> Page: Pilih hapus bahan
Page --> Inventori: Konfirmasi hapus?
Inventori -> Page: Konfirmasi

Page -> Material: checkUsage(id)
Material -> DB: SELECT FROM product_compositions WHERE material_id = ?

alt Bahan digunakan di produk
    Page --> Inventori: Peringatan: Akan dinonaktifkan
    Page -> Material: update(['is_active' => false])
    Material -> DB: UPDATE materials SET is_active = false
else Tidak digunakan
    Page -> Material: delete(id)
    Material -> DB: DELETE FROM materials
end

Page --> Inventori: Bahan berhasil dihapus

@enduml
