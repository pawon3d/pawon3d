@startuml sequence-poin-pelanggan

title Sequence Diagram: Penggunaan Poin Pelanggan

actor "Kasir" as user
participant "Transaction/RincianPesanan\n(Livewire)" as form
participant "Transaction\n(Model)" as trans
participant "Customer\n(Model)" as customer
participant "PointsHistory\n(Model)" as history
database "Database" as db

user -> form : Akses pembayaran transaksi
activate form

form -> trans : find(id)->with(customer)
trans -> db : SELECT * FROM transactions JOIN customers
db --> trans : transaction with customer
trans --> form : Transaction object

alt Ada pelanggan
    form -> customer : find(customer_id)
    customer -> db : SELECT * FROM customers
    db --> customer : customer data
    customer --> form : Customer (poin tersedia)
    
    form --> user : Tampilkan poin tersedia : X poin

    user -> form : Klik gunakan poin
    user -> form : Input jumlah poin
    
    form -> form : Validasi poin <= poin tersedia
    
    alt Poin valid
        form -> form : Hitung nilai diskon\n(1 poin = Rp 100)
        
        note right of form
            Contoh:
            100 poin = Rp 10.000 diskon
        end note
        
        form -> form : Update total tagihan\n(total - diskon)
        
        form --> user : Tampilkan diskon dan total baru
        
        == Saat Pembayaran Selesai ==
        
        user -> form : Konfirmasi pembayaran
        
        form -> trans : update(points_used = X)
        trans -> db : UPDATE transactions SET points_used
        db --> trans : OK
        
        form -> customer : decrement(points, X)
        customer -> db : UPDATE customers SET points = points - X
        db --> customer : OK
        
        form -> history : create(penggunaan)
        activate history
        
        history -> history : phone = customer.phone
        history -> history : transaction_id = trans.id
        history -> history : points_change = -X
        history -> history : description = "Penggunaan untuk diskon"
        
        history -> db : INSERT INTO points_histories
        db --> history : OK
        
        deactivate history
        
        form --> user : Poin berhasil digunakan
        
    else Poin melebihi saldo
        form --> user : Error: Poin tidak mencukupi
    end
    
else Tidak ada pelanggan
    form --> user : Fitur poin tidak tersedia\n(transaksi tanpa pelanggan)
end

deactivate form

@enduml
