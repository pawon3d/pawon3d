@startuml Sequence - Refund Transaksi

actor Kasir
participant "Transaction Page\n(Livewire)" as Page
participant Transaction
participant Payment
participant PaymentChannel
participant Refund
participant Shift
participant Notification as Notif
database DB

Kasir -> Page: Pilih transaksi
Kasir -> Page: Klik "Batalkan"

Page -> Transaction: with('payments', 'details')->find(id)
Transaction -> DB: SELECT * FROM transactions\nJOIN payments\nJOIN transaction_details
DB --> Transaction: data transaksi

Page --> Kasir: Tampilkan form refund

Kasir -> Page: Input reason,\nrefund_method,\nproof_image

alt refund_method != "Tunai"
    Page -> PaymentChannel: where('is_active', true)->get()
    PaymentChannel -> DB: SELECT * FROM payment_channels
    DB --> PaymentChannel: channels
    PaymentChannel --> Page: channels
    
    Kasir -> Page: Pilih payment_channel_id,\ninput account_number
end

Page -> Refund: create(transaction_id,\nreason,\nrefund_method,\npayment_channel_id,\naccount_number,\ntotal_amount,\nrefunded_at)
Refund -> DB: INSERT refunds
DB --> Refund: refund

Page -> Transaction: update(status="Dibatalkan",\ntotal_refund=total_amount)
Transaction -> DB: UPDATE transactions

alt Ada shift aktif
    Page -> Shift: where('status', 'Buka')\n->where('opened_by', user_id)\n->first()
    Shift -> DB: SELECT * FROM shifts
    DB --> Shift: active_shift
    
    Page -> Refund: update(refund_by_shift=shift_id)
    Refund -> DB: UPDATE refunds
    
    Page -> Transaction: update(refund_by_shift=shift_id)
    Transaction -> DB: UPDATE transactions
end

Page -> Notif: orderRefunded(invoice_number)
Notif -> DB: INSERT notifications

Page --> Kasir: Refund berhasil

@enduml
