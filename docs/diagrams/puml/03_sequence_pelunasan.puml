@startuml Sequence Diagram - Pelunasan Pembayaran

actor Kasir
participant "Transaction Page\n(Livewire)" as Page
participant "Transaction\nModel" as Transaction
participant "Payment\nModel" as Payment
participant "PaymentChannel\nModel" as Channel
participant "Customer\nModel" as Customer
participant "PointsHistory\nModel" as Points
participant "NotificationService" as Notif
database Database as DB

== Melihat Transaksi DP ==
Kasir -> Page: Filter status "Uang Muka"
Page -> Transaction: where('payment_status', 'Uang Muka')->get()
Transaction -> DB: SELECT * FROM transactions WHERE payment_status = 'Uang Muka'
DB --> Transaction: DP transactions
Transaction --> Page: transactions list

Page --> Kasir: Tampilkan daftar transaksi DP

== Memilih Transaksi untuk Dilunasi ==
Kasir -> Page: Pilih transaksi
Page -> Transaction: find(id)->with(['payments', 'customer'])
Transaction -> DB: SELECT dengan relasi
DB --> Transaction: transaction data

Page -> Payment: where('transaction_id', id)->sum('paid_amount')
Payment -> DB: SELECT SUM(paid_amount) FROM payments
DB --> Payment: total paid

Page --> Kasir: Tampilkan detail
note right
  - Total tagihan
  - Sudah dibayar (DP)
  - Sisa tagihan
end note

== Proses Pelunasan ==
Kasir -> Page: Klik "Lunasi"
Kasir -> Page: Pilih metode pembayaran

alt Pembayaran Tunai
    Kasir -> Page: Masukkan jumlah uang
    
    Page -> Page: Validasi jumlah
    alt Uang kurang
        Page --> Kasir: Error: Jumlah kurang dari sisa tagihan
    else Uang cukup
        Page -> Page: Hitung kembalian
        Page --> Kasir: Tampilkan kembalian
    end
    
else Pembayaran Non-Tunai
    Kasir -> Page: Pilih channel pembayaran
    Page -> Channel: where('is_active', true)->get()
    Channel -> DB: SELECT * FROM payment_channels
    DB --> Channel: channels list
    Channel --> Page: available channels
    
    Kasir -> Page: Pilih channel (QRIS/Transfer/dll)
end

Kasir -> Page: Konfirmasi pelunasan

== Menyimpan Pembayaran ==
Page -> Payment: create(paymentData)
note right
  paid_amount: sisa_tagihan
  payment_method: tunai/non-tunai
  payment_channel_id: (jika non-tunai)
end note
Payment -> DB: INSERT INTO payments
DB --> Payment: payment created

Page -> Transaction: update(['payment_status' => 'Lunas'])
Transaction -> DB: UPDATE transactions SET payment_status = 'Lunas'
DB --> Transaction: updated

== Menambah Poin Pelanggan ==
alt Pelanggan terdaftar
    Page -> Transaction: get customer_id
    Transaction --> Page: customer_id
    
    Page -> Page: Hitung poin
    note right
      points = floor(total_amount / 10000)
      1 poin per Rp 10.000
    end note
    
    Page -> Customer: increment('points', earned_points)
    Customer -> DB: UPDATE customers SET points = points + earned
    DB --> Customer: updated
    
    Page -> Points: create(pointsHistory)
    note right
      action: 'earn'
      points: +earned_points
      transaction_id: id
      description: 'Pelunasan invoice #xxx'
    end note
    Points -> DB: INSERT INTO points_histories
    DB --> Points: history created
end

== Kirim Notifikasi ==
Page -> Notif: paymentCompleted(transaction)
Notif -> DB: INSERT INTO notifications
note right
  title: 'Pelunasan Berhasil'
  body: 'Invoice #xxx telah lunas'
end note

Page --> Kasir: Pelunasan berhasil!\nCetak struk?

alt Cetak Struk
    Kasir -> Page: Ya, cetak
    Page --> Kasir: Generate & print struk
else Tidak Cetak
    Kasir -> Page: Tidak
end

@enduml
