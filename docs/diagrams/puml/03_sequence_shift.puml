@startuml Sequence - Shift Kasir (Buka/Tutup)

actor Kasir
participant "POS Page" as POS
participant Shift
participant Transaction
participant Payment
participant Notification as Notif
database DB

== Buka Shift ==
Kasir -> POS: GET /transaksi
POS -> Shift: where('status', 'Buka')\n->where('opened_by', user_id)\n->first()
Shift -> DB: SELECT * FROM shifts
DB --> Shift: shift|null

alt Tidak ada shift aktif
    Shift --> POS: null
    POS --> Kasir: Tampilkan modal\n"Buka Sesi"
    
    Kasir -> POS: Input kas awal
    POS -> Shift: create(shift_number,\nopened_by,\ninitial_cash,\nstatus="Buka")
    Shift -> DB: INSERT shifts
    DB --> Shift: shift created
    Shift --> POS: shift
else Ada shift aktif
    Shift --> POS: shift
    POS --> Kasir: Tampilkan POS\n(siap transaksi)
end

== Tutup Shift ==
Kasir -> POS: Klik "Tutup Sesi"
Kasir -> POS: Input kas akhir

POS -> Transaction: where('created_by_shift', shift_id)\n->sum('total_amount')
Transaction -> DB: SELECT SUM(total_amount)
DB --> Transaction: total_sales

POS -> Transaction: where('refund_by_shift', shift_id)\n->sum('total_refund')
Transaction -> DB: SELECT SUM(total_refund)
DB --> Transaction: total_refunds

POS -> Shift: update(closed_by,\nend_time,\nfinal_cash,\ntotal_sales,\ntotal_refunds,\nstatus="Tutup")
Shift -> DB: UPDATE shifts
DB --> Shift: success

POS -> Notif: shiftClosed(shift_number)
Notif -> DB: INSERT notifications

POS --> Kasir: Shift ditutup,\ntampilkan ringkasan

@enduml
