@startuml Sequence - Produksi (Pesanan/Siap Beli)

actor Produksi
participant "Production Page\n(Livewire)" as Page
participant Production as Prod
participant ProdDetail
participant ProductComp
participant MaterialBatch
participant InventoryLog
participant Product
participant Transaction
participant Notification as Notif
database DB

== Pilih Produksi ==
Produksi -> Page: GET /produksi
Page -> Prod: where('status', 'Antrian')->get()
Prod -> DB: SELECT * FROM productions
DB --> Prod: list produksi
Prod --> Page: antrian produksi

Produksi -> Page: Pilih produksi
Page -> Prod: with('details.product', 'transaction')->find(id)
Prod -> DB: SELECT * FROM productions\nJOIN production_details\nJOIN products
DB --> Prod: detail produksi

== Cek Stok Bahan ==
Page -> ProdDetail: get()
loop setiap item produk
    ProdDetail -> ProductComp: where('product_id')->get()
    ProductComp -> DB: SELECT * FROM\nproduct_compositions
    DB --> ProductComp: komposisi bahan
    
    ProductComp -> MaterialBatch: where('material_id')\n->orderBy('date', 'asc')\n->sum('batch_quantity')
    MaterialBatch -> DB: SELECT SUM(batch_quantity)\nFROM material_batches\n(FIFO)
    DB --> MaterialBatch: total stok
end

alt Stok tidak cukup
    Page --> Produksi: Error stok kurang
else Stok cukup
    == Mulai Produksi ==
    Produksi -> Page: Pilih pekerja,\nmulai produksi
    
    Page -> Prod: update(status="Proses",\nis_start=true,\nstart_date=now)
    Prod -> DB: UPDATE productions
    
    loop setiap bahan
        Page -> MaterialBatch: kurangiBatch(material_id, qty)\n(FIFO)
        MaterialBatch -> DB: UPDATE material_batches
        
        Page -> InventoryLog: create(action="out",\nreference_type="Production",\nquantity_change)
        InventoryLog -> DB: INSERT inventory_logs
    end
    
    == Input Hasil ==
    Produksi -> Page: Input qty jadi & gagal
    
    Page -> ProdDetail: update(quantity_get,\nquantity_fail)
    ProdDetail -> DB: UPDATE production_details
    
    Page -> Product: increment(stock, qty_jadi)
    Product -> DB: UPDATE products
    
    Page -> Prod: update(status="Selesai",\nis_finish=true,\nend_date=now)
    Prod -> DB: UPDATE productions
    
    alt Terkait transaksi
        Page -> Transaction: update(status="Dapat Diambil")
        Transaction -> DB: UPDATE transactions
    end
    
    Page -> Notif: productionCompleted(production_number)
    Notif -> DB: INSERT notifications
    
    Page --> Produksi: Produksi selesai
end

@enduml
