@startuml ERD Pawon3D
!define primary_key(x) <b><u>x</u></b>
!define foreign_key(x) <i>x</i>
skinparam linetype ortho
hide circle

' === MODUL MANAJEMEN PENGGUNA ===
entity "users" as users {
  primary_key(id) : UUID
  --
  name : VARCHAR(50)
  email : VARCHAR(100) <<unique>>
  phone : VARCHAR(20)
  password : VARCHAR(255)
  image : VARCHAR(255)
  gender : VARCHAR(20)
  is_active : BOOLEAN
  invitation_token : VARCHAR(64)
  invitation_sent_at : TIMESTAMP
  activated_at : TIMESTAMP
  remember_token : VARCHAR(100)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "roles" as roles {
  primary_key(id) : BIGINT
  --
  name : VARCHAR(255)
  guard_name : VARCHAR(255)
  max_users : INT
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "permissions" as permissions {
  primary_key(id) : BIGINT
  --
  name : VARCHAR(255)
  guard_name : VARCHAR(255)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "model_has_roles" as model_has_roles {
  primary_key(role_id) : BIGINT
  primary_key(model_type) : VARCHAR(255)
  primary_key(model_id) : BIGINT
}

entity "role_has_permissions" as role_has_permissions {
  primary_key(permission_id) : BIGINT
  primary_key(role_id) : BIGINT
}

' === MODUL INVENTORI ===
entity "categories" as categories {
  primary_key(id) : UUID
  --
  name : VARCHAR(50)
  is_active : BOOLEAN
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "units" as units {
  primary_key(id) : UUID
  --
  name : VARCHAR(30) <<unique>>
  alias : VARCHAR(10)
  group : VARCHAR(30)
  foreign_key(base_unit_id) : UUID <<FK>>
  conversion_factor : DECIMAL(20,10)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "suppliers" as suppliers {
  primary_key(id) : UUID
  --
  name : VARCHAR(50)
  description : VARCHAR(255)
  contact_name : VARCHAR(50)
  phone : VARCHAR(20)
  street : VARCHAR(255)
  landmark : VARCHAR(255)
  maps_link : VARCHAR(500)
  image : VARCHAR(255)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "materials" as materials {
  primary_key(id) : UUID
  --
  name : VARCHAR(50)
  description : VARCHAR(255)
  image : VARCHAR(255)
  expiry_date : DATE
  status : VARCHAR(20)
  is_active : BOOLEAN
  is_recipe : BOOLEAN
  minimum : DECIMAL(15,5)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "material_batches" as material_batches {
  primary_key(id) : UUID
  --
  foreign_key(material_id) : UUID <<FK>>
  foreign_key(unit_id) : UUID <<FK>>
  batch_number : VARCHAR(255)
  date : DATE
  batch_quantity : DECIMAL(15,2)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "inventory_logs" as inventory_logs {
  primary_key(id) : UUID
  --
  foreign_key(material_id) : UUID <<FK>>
  foreign_key(material_batch_id) : UUID <<FK>>
  foreign_key(user_id) : UUID <<FK>>
  action : VARCHAR(255)
  quantity_change : DECIMAL(15,4)
  quantity_after : DECIMAL(15,4)
  reference_type : VARCHAR(255)
  reference_id : VARCHAR(255)
  note : TEXT
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

' === MODUL BELANJA ===
entity "expenses" as expenses {
  primary_key(id) : UUID
  --
  expense_number : VARCHAR(255) <<unique>>
  expense_date : DATE
  end_date : DATE
  foreign_key(supplier_id) : UUID <<FK>>
  note : VARCHAR(255)
  status : VARCHAR(255)
  grand_total_expect : DECIMAL(10,2)
  grand_total_actual : DECIMAL(10,2)
  is_start : BOOLEAN
  is_finish : BOOLEAN
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "expense_details" as expense_details {
  primary_key(id) : UUID
  --
  foreign_key(expense_id) : UUID <<FK>>
  foreign_key(material_id) : UUID <<FK>>
  foreign_key(unit_id) : UUID <<FK>>
  quantity_expect : DECIMAL(15,5)
  quantity_get : DECIMAL(15,5)
  is_quantity_get : BOOLEAN
  price_expect : DECIMAL(10,2)
  price_get : DECIMAL(10,2)
  total_expect : DECIMAL(10,2)
  total_actual : DECIMAL(10,2)
  expiry_date : DATE
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

' === MODUL PRODUK ===
entity "products" as products {
  primary_key(id) : UUID
  --
  name : VARCHAR(50)
  description : VARCHAR(50)
  price : DECIMAL(10,0)
  stock : DECIMAL(10,0)
  method : JSON
  product_image : VARCHAR(255)
  is_recipe : BOOLEAN
  is_active : BOOLEAN
  is_recommended : BOOLEAN
  is_other : BOOLEAN
  pcs : DECIMAL(10,0)
  pcs_capital : DECIMAL(10,0)
  capital : DECIMAL(10,0)
  suhu_ruangan : DECIMAL(3,0)
  suhu_dingin : DECIMAL(3,0)
  suhu_beku : DECIMAL(3,0)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "product_compositions" as product_compositions {
  primary_key(id) : UUID
  --
  foreign_key(product_id) : UUID <<FK>>
  foreign_key(material_id) : UUID <<FK>>
  foreign_key(unit_id) : UUID <<FK>>
  material_quantity : DECIMAL(8,2)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "type_costs" as type_costs {
  primary_key(id) : UUID
  --
  name : VARCHAR(50)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "other_costs" as other_costs {
  primary_key(id) : UUID
  --
  foreign_key(product_id) : UUID <<FK>>
  foreign_key(type_cost_id) : UUID <<FK>>
  price : DECIMAL(15,2)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

' === MODUL PRODUKSI ===
entity "productions" as productions {
  primary_key(id) : UUID
  --
  production_number : VARCHAR(255)
  foreign_key(transaction_id) : UUID <<FK>>
  method : VARCHAR(255)
  date : DATE
  time : TIME
  start_date : DATE
  end_date : DATE
  note : VARCHAR(255)
  status : VARCHAR(20)
  is_start : BOOLEAN
  is_finish : BOOLEAN
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "production_details" as production_details {
  primary_key(id) : UUID
  --
  foreign_key(production_id) : UUID <<FK>>
  foreign_key(product_id) : UUID <<FK>>
  quantity_plan : DECIMAL(8,0)
  quantity_get : DECIMAL(8,0)
  quantity_fail : DECIMAL(8,0)
  cycle : DECIMAL(2,0)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "production_workers" as production_workers {
  primary_key(id) : UUID
  --
  foreign_key(production_id) : UUID <<FK>>
  foreign_key(user_id) : UUID <<FK>>
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

' === MODUL KASIR ===
entity "customers" as customers {
  primary_key(id) : UUID
  --
  phone : VARCHAR(255) <<unique>>
  name : VARCHAR(50)
  points : DECIMAL(9,0)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "shifts" as shifts {
  primary_key(id) : UUID
  --
  shift_number : VARCHAR(255) <<unique>>
  foreign_key(opened_by) : UUID <<FK>>
  foreign_key(closed_by) : UUID <<FK>>
  start_time : DATETIME
  end_time : DATETIME
  status : VARCHAR(255)
  initial_cash : DECIMAL(10,0)
  final_cash : DECIMAL(10,0)
  total_sales : DECIMAL(10,2)
  total_refunds : DECIMAL(10,2)
  total_discounts : DECIMAL(10,2)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "transactions" as transactions {
  primary_key(id) : UUID
  --
  foreign_key(user_id) : UUID <<FK>>
  foreign_key(customer_id) : UUID <<FK>>
  invoice_number : VARCHAR(30) <<unique>>
  name : VARCHAR(50)
  phone : VARCHAR(20)
  date : DATE
  time : TIME
  start_date : DATE
  end_date : DATE
  note : TEXT
  payment_status : VARCHAR(20)
  status : VARCHAR(20)
  method : VARCHAR(20)
  total_amount : DECIMAL(15,0)
  points_used : INT
  points_discount : DECIMAL(15,2)
  total_refund : DECIMAL(15,0)
  cancel_reason : TEXT
  cancel_proof_image : VARCHAR(255)
  foreign_key(created_by_shift) : UUID <<FK>>
  foreign_key(refund_by_shift) : UUID <<FK>>
  foreign_key(cancelled_by_shift) : UUID <<FK>>
  cancelled_at : TIMESTAMP
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "transaction_details" as transaction_details {
  primary_key(id) : UUID
  --
  foreign_key(transaction_id) : UUID <<FK>>
  foreign_key(product_id) : UUID <<FK>>
  quantity : SMALLINT
  price : DECIMAL(15,0)
  refund_quantity : SMALLINT
  pcs_capital_snapshot : DECIMAL(15,2)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "payment_channels" as payment_channels {
  primary_key(id) : UUID
  --
  name : VARCHAR(50)
  type : VARCHAR(50)
  account_name : VARCHAR(100)
  account_number : VARCHAR(50)
  is_active : BOOLEAN
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "payments" as payments {
  primary_key(id) : UUID
  --
  receipt_number : VARCHAR(30) <<unique>>
  foreign_key(transaction_id) : UUID <<FK>>
  foreign_key(payment_channel_id) : UUID <<FK>>
  payment_method : VARCHAR(20)
  payment_group : VARCHAR(20)
  paid_amount : DECIMAL(15,0)
  image : VARCHAR(255)
  paid_at : TIMESTAMP
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "refunds" as refunds {
  primary_key(id) : UUID
  --
  foreign_key(transaction_id) : UUID <<FK>>
  refund_number : VARCHAR(255)
  refund_amount : DECIMAL(15,0)
  refund_reason : TEXT
  refund_image : VARCHAR(255)
  refunded_at : TIMESTAMP
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "points_histories" as points_histories {
  primary_key(id) : UUID
  --
  phone : VARCHAR(20)
  action_id : VARCHAR(30)
  action : VARCHAR(50)
  points : INT
  foreign_key(transaction_id) : UUID <<FK>>
  image : VARCHAR(255)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

' === MODUL STOCK OPNAME ===
entity "hitungs" as hitungs {
  primary_key(id) : UUID
  --
  foreign_key(user_id) : UUID <<FK>>
  hitung_number : VARCHAR(30) <<unique>>
  action : VARCHAR(50)
  note : VARCHAR(255)
  status : VARCHAR(20)
  hitung_date : DATE
  hitung_date_finish : DATE
  is_start : BOOLEAN
  is_finish : BOOLEAN
  grand_total : DECIMAL(15,2)
  loss_grand_total : DECIMAL(15,2)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "hitung_details" as hitung_details {
  primary_key(id) : UUID
  --
  foreign_key(hitung_id) : UUID <<FK>>
  foreign_key(material_id) : UUID <<FK>>
  foreign_key(material_batch_id) : UUID <<FK>>
  quantity_expect : DECIMAL(15,2)
  quantity_actual : DECIMAL(15,2)
  total : DECIMAL(15,2)
  loss_total : DECIMAL(15,2)
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity "notifications" as notifications {
  primary_key(id) : UUID
  --
  foreign_key(user_id) : UUID <<FK>>
  title : VARCHAR(100)
  body : TEXT
  type : VARCHAR(20)
  is_read : BOOLEAN
  status : TINYINT
  created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

' === RELASI ===
' User & Role
roles ||--o{ model_has_roles
users }o--|| model_has_roles
roles ||--o{ role_has_permissions
permissions ||--o{ role_has_permissions

' Unit Self-Reference
units ||--o{ units : base_unit_id

' Material & Batch
materials ||--o{ material_batches
materials ||--o{ inventory_logs
material_batches ||--o{ inventory_logs
users ||--o{ inventory_logs

' Expense
suppliers ||--o{ expenses
expenses ||--o{ expense_details
materials ||--o{ expense_details
units ||--o{ expense_details

' Product
products ||--o{ product_compositions
materials ||--o{ product_compositions
units ||--o{ product_compositions
products ||--o{ other_costs
type_costs ||--o{ other_costs

' Production
transactions ||--o{ productions
productions ||--o{ production_details
products ||--o{ production_details
productions ||--o{ production_workers
users ||--o{ production_workers

' Transaction
users ||--o{ transactions
customers ||--o{ transactions
shifts ||--o{ transactions : created_by_shift
shifts ||--o{ transactions : refund_by_shift
shifts ||--o{ transactions : cancelled_by_shift
transactions ||--o{ transaction_details
products ||--o{ transaction_details
transactions ||--o{ payments
payment_channels ||--o{ payments
transactions ||--o{ refunds
transactions ||--o{ points_histories
customers ||--o{ points_histories : phone

' Shift
users ||--o{ shifts : opened_by
users ||--o{ shifts : closed_by

' Stock Opname
users ||--o{ hitungs
hitungs ||--o{ hitung_details
materials ||--o{ hitung_details
material_batches ||--o{ hitung_details

' Notification
users ||--o{ notifications

@enduml
