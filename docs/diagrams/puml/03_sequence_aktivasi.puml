@startuml Sequence - Aktivasi Akun

actor Pekerja
participant "Aktivasi Page\n(Livewire)" as ActivatePage
participant "User Model" as UserModel
participant "Auth Facade" as Auth
participant Session
database DB

Pekerja -> ActivatePage: GET /aktivasi-akun/{token}
ActivatePage -> UserModel: where('invitation_token', token)->first()
UserModel -> DB: SELECT * FROM users\nWHERE invitation_token=?
DB --> UserModel: user|null

alt Token tidak valid/expired
    UserModel --> ActivatePage: null
    ActivatePage --> Pekerja: Error token\ntidak valid/expired
else Token valid
    UserModel --> ActivatePage: user data
    ActivatePage --> Pekerja: Form set password

    Pekerja -> ActivatePage: POST password,\npassword_confirmation
    ActivatePage -> ActivatePage: validate(password rules)
    
    alt Validasi gagal
        ActivatePage --> Pekerja: Error validasi
    else Validasi berhasil
        ActivatePage -> UserModel: update(is_active=true,\npassword=hash,\nactivated_at=now)
        UserModel -> DB: UPDATE users SET\nis_active=1,\npassword=?,\nactivated_at=?
        DB --> UserModel: success
        
        ActivatePage -> UserModel: update(invitation_token=null)
        UserModel -> DB: UPDATE users SET\ninvitation_token=NULL
        
        ActivatePage -> Auth: login(user)
        Auth -> Session: regenerate()
        Auth -> Session: store(user_id)
        
        ActivatePage -> UserModel: hasAnyPermission()
        UserModel -> DB: SELECT permissions
        
        alt Ada permission
            ActivatePage --> Pekerja: Redirect dashboard\n(ringkasan sesuai role)
        else Tidak ada permission
            ActivatePage --> Pekerja: Redirect menunggu-peran
        end
    end
end

@enduml
